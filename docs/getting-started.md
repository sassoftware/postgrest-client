## Getting started

`@sassoftware/postgrest-client` is designed to be a type safe PostgREST client.
It also supports JavaScript.

It should work in multiple runtimes like Node.js, Deno, Bun, edge functions, etc.
but at this moment it has not been tested.

### Installation

```bash
npm install @sassoftware/postgrest-client
```

### Database definition

`@sassoftware/postgrest-client` exports a named type `PostgresTable` as a helper
for simple table definitions.

Example:

```ts
type DB = {
  // autogenerated `id` column (2nd generic), and optional `col` column
  my_table: PostgresTable<{ id: number; col: string }, 'id'>;
};
```

Definition for relation at https://postgrest.org/en/stable/references/api/resource_embedding.html#relationships:

```ts
type Actors = PostgresTable<
  { id: number; first_name: string | null; last_name: string | null },
  'id'
>;

type Directors = PostgresTable<
  { id: number; first_name: string | null; last_name: string | null },
  'id'
>;

type Films = PostgresTable<
  {
    id: number;
    director_id: number | null;
    title: string | null;
    year: number | null;
    rating: number | null;
    language: string | null;
  },
  'id'
>;

type TechnicalSpecs = PostgresTable<{
  film_id: number | null;
  runtime: string | null;
  camera: string | null;
  sound: string | null;
}>;

type Roles = PostgresTable<
  {
    film_id: number;
    actor_id: number;
    character: string | null;
  },
  'film_id' | 'actor_id'
>;

type Competitions = PostgresTable<
  {
    id: number;
    name: string | null;
    year: number | null;
  },
  'id'
>;

type Nominations = PostgresTable<
  {
    competition_id: number;
    film_id: number;
    rank: number | null;
  },
  'competition_id' | 'film_id'
>;

type DB = {
  actors: Actors;
  directors: Directors;
  films: Films;
  technical_specs: TechnicalSpecs;
  roles: Roles;
  competitions: Competitions;
  nominations: Nominations;
};
```

### Instantiation

```ts
const pgClient = new PostgrestClient<DB>({
  // URL (https://example.com/some-api) or URL path on the same origin
  base: '/api',
  // optional axios instance. Otherwise builtin `fetch` will be used
  axiosInstance: axios.create(),
  // optional flag to disable params encoding
  encodeQueryStrings: false,
});
```

### Queries

Client instance exposes `.query` returning immutable chainable query instances.
Example:

```ts
const query = pgClient.query('films').select('title').select('year');
const query2 = query.eq('id', 1);
```

[More examples](./queries.md)

### Making requests

```ts
const { rows, status, headers, statusText } = await pgClient.get({
  query: pgClient.query('films'),
});
```

Supported methods are `GET`, `HEAD`, `POST`, `PATCH`, `PUT`, `DELETE` (`.get`, `.head`, `.post`, `.patch`, `.put`, `.delete`)

All methods accept an object with `query` parameter as described in the example above,
as well as `headers` object for passing custom request headers.
`.post`, `.put`, `patch` accept `data` parameter as request payload.
For more information take a look at TSDoc/JSDoc, TypeScript types or [tests](../test/postgrest-client.test.ts).

Response object is influenced by the `query` parameter and can be different depending on the query string or headers.
More information in [query documentation](./queries.md).

### Error handling

```js
try {
  await pgClient.patch({
    query: pgClient.query('films'),
    // TypeScript would flag this, but in case this is used
    // in a JavaScript project, this could be an easy mistake to make
    data: { non_existing: 4.5 },
  });
} catch (err) {
  if (err instanceof PostgrestError) {
    console.log(err.message);
    console.log('http status:', err.status);
    console.log('code:', err.data.code);
    console.log('db message:', err.data.message);
  }
}
```
